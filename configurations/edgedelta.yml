version: v3

settings:
  tag: http-benchmark
  log:
    level: info
    buffer_size: 1000
    flush_bytesize: 16MB
    flush_interval: 30m0s
    post_config_change_flush_interval: 1m0s
    post_config_change_flush_interval_window: 15m0s
  archive_flush_interval: 1m0s
  archive_max_byte_limit: 16MB
  read_settings: {}
  live_tail_settings:
    enabled: false
    max_items: 10
    polling_interval: 5s
    item_max_body_size: 2KB
    item_truncation_size: 5MB
    lower_threshold_size: 1MB
    upper_threshold_size: 10MB
  persisting_cursor_settings: {}

links:
- from: ed_self_telemetry_input
  to: edgedelta
- from: edgedelta_multiprocessor
  to: edgedelta
- from: http_input_b410
  to: http_input_b410_multiprocessor
- from: http_input_b410_multiprocessor
  to: s3_output_b7e2_multiprocessor
- from: s3_output_b7e2_multiprocessor
  to: s3_output_b7e2

nodes:
- name: ed_self_telemetry_input
  type: ed_self_telemetry_input
  enable_health_metrics: true
  enable_agent_stats_metrics: true
- name: edgedelta_multiprocessor
  type: sequence
  processors:
  - type: sample
    metadata: '{"id":"X8332caR9PyaCLVp7DlZ_","type":"sample","name":"Sample"}'
    data_types:
    - log
    percentage: 1
    pass_through_on_failure: true
- name: edgedelta
  type: ed_output
  user_description: Edge Delta
- name: http_input_b410
  type: http_input
  user_description: HTTP Source
  port: 8085
  compression: uncompressed
  read_timeout: 1m0s
  log_parsing_mode: json
- name: http_input_b410_multiprocessor
  type: sequence
  user_description: Multi Processor
  processors:
  - type: generic_mask
    metadata: '{"id":"tfHmqmId2_4IdMOyK6zK2","type":"generic_mask","name":"Mask"}'
    data_types:
    - log
    capture_group_masks:
    - enabled: true
      capture_group: ((25[0-5]|(2[0-4]|1\d|[1-9]|)\d)\.?\b){4}
      mask: REDACTED
      name: IPv4 Address
    - enabled: true
      capture_group: '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}'
      mask: REDACTED
      name: Email Address
    - enabled: true
      capture_group: (5[1-5][0-9]{14}|222[1-9][0-9]{12}|22[3-9][0-9]{13}|2[3-6][0-9]{14}|27[01][0-9]{13}|2720[0-9]{12})
      mask: REDACTED
      name: Credit Card Number (Mastercard)
    - enabled: true
      capture_group: 3[47][0-9]{13}
      mask: REDACTED
      name: Credit Card Number (Amex)
    - enabled: true
      capture_group: 4[0-9]{12}(?:[0-9]{3})?
      mask: REDACTED
      name: Credit Card Number (Visa)
    - enabled: true
      capture_group: 6(?:011|4[4-9][0-9]|5[0-9][0-9])[0-9]{12}
      mask: REDACTED
      name: Credit Card Number (Discover)
    - enabled: true
      capture_group: '[A-Z]{2}[0-9]{2}[A-Z0-9]{4}[0-9]{7}([A-Z0-9]?){0,16}'
      mask: REDACTED
      name: International Bank Account Number
    - enabled: true
      capture_group: (([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))
      mask: REDACTED
      name: IPv6 Address
    - enabled: true
      capture_group: ([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})
      mask: REDACTED
      name: MAC Address
  - type: ottl_filter
    metadata: '{"id":"0qsbzv_jfRJ5YAeDg5kUZ","type":"filter","name":"Filter"}'
    condition: body["pii[\"color\"]"] == "Green"
    data_types:
    - log
    filter_mode: exclude
  - type: ottl_transform
    metadata: '{"id":"0w-axIiEQOz_ku3koaP58","type":"copy-field","name":"Copy IP Address"}'
    data_types:
    - log
    statements: set(attributes["ip_address"], body["pii[\"ipv4\"]"])
  - type: lookup
    metadata: '{"id":"-zT4v9gYMwncj1VN2XySs","type":"lookup","name":"Lookup"}'
    data_types:
    - log
    location_path: ed://lookup-benchmark.csv
    reload_period: 100ms
    key_fields:
    - event_field: attributes["ip_address"]
      lookup_field: ip_address
    out_fields:
    - event_field: attributes["region"]
      lookup_field: region
      default_value: unknown
      append_mode: true
    - event_field: attributes["env"]
      lookup_field: env
      default_value: unknown
      append_mode: true
- name: s3_output_b7e2
  type: s3_output
  user_description: S3 Destination
  schema: Archive
  compression: gzip
  region: us-west-2
  parallel_worker_count: 2
  bucket: <REDACTED>
  encoding: json
  use_native_compression: false
  disable_metadata_ingestion: false
  path_prefix:
    order:
    - Year
    - Month
    - Day
    - Hour
    format: edgedelta/%s/%s/%s/%s/
- name: s3_output_b7e2_multiprocessor
  type: sequence
  user_description: Multi Processor
  processors:
  - type: sample
    metadata: '{"id":"KCWmAQXzTcCju6XRtiSBA","type":"sample","name":"Sample"}'
    data_types:
    - log
    percentage: 5
    pass_through_on_failure: true
